'use client'

import { useState, useMemo } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Download, ShoppingCart, Clock, Cpu, Layers, Tag, Star, Filter } from 'lucide-react'
import { featuredModels, FeaturedModel, calculateDiscount } from '../data/featured-models'
import dynamic from 'next/dynamic'

// Dynamic import for 3D viewer
const Model3DViewer = dynamic(() => import('./Model3DViewer'), {
  ssr: false,
  loading: () => (
    <div className="w-full h-full min-h-[400px] bg-black/50 rounded-sm animate-pulse" />
  )
})

export default function ModelCatalog() {
  const [selectedModel, setSelectedModel] = useState<FeaturedModel | null>(null)
  const [filter, setFilter] = useState<'all' | 'classic' | 'modern' | 'supercar' | 'racing' | 'vintage'>('all')
  const [sortBy, setSortBy] = useState<'popular' | 'price' | 'newest'>('popular')

  // Filter and sort models
  const filteredModels = useMemo(() => {
    let models = filter === 'all' 
      ? featuredModels 
      : featuredModels.filter(m => m.category === filter);

    // Sort models
    switch (sortBy) {
      case 'price':
        return models.sort((a, b) => a.price - b.price);
      case 'newest':
        return models.sort((a, b) => parseInt(b.year) - parseInt(a.year));
      case 'popular':
      default:
        return models.sort((a, b) => b.popularity - a.popularity);
    }
  }, [filter, sortBy]);

  const handleDownload = (model: FeaturedModel) => {
    // In production, this would handle payment and then provide download
    // Simulate download
    const link = document.createElement('a');
    link.href = model.stlUrl;
    link.download = `${model.name.replace(/\s+/g, '-').toLowerCase()}.stl`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <section className="py-32 border-t border-white/5">
      <div className="max-w-7xl mx-auto px-8 md:px-16">
        {/* Header */}
        <div className="mb-16">
          <h3 className="text-[11px] font-extralight tracking-[0.3em] uppercase text-gray-400 mb-4">
            Premium Collection
          </h3>
          <h2 className="text-5xl md:text-7xl font-thin tracking-tight mb-4">
            3D Print Catalog
          </h2>
          <p className="text-sm font-extralight text-gray-400 max-w-2xl mb-8">
            Curated collection of the finest car models ready for 3D printing. 
            Each model is optimized for quality and ease of printing.
          </p>
        </div>

        {/* Filters */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6">
          <div className="flex flex-wrap gap-2">
            {['all', 'classic', 'modern', 'supercar', 'racing', 'vintage'].map((category) => (
              <button
                key={category}
                onClick={() => setFilter(category as any)}
                className={`
                  px-4 py-2 text-[11px] font-extralight uppercase tracking-[0.2em] 
                  border transition-all
                  ${filter === category 
                    ? 'border-white/30 bg-white/5' 
                    : 'border-white/10 hover:border-white/20'
                  }
                `}
              >
                {category}
              </button>
            ))}
          </div>

          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value as any)}
            className="bg-transparent border border-white/10 px-4 py-2 text-[11px] font-extralight uppercase tracking-[0.2em] focus:outline-none focus:border-white/30"
          >
            <option value="popular">Most Popular</option>
            <option value="price">Price: Low to High</option>
            <option value="newest">Newest First</option>
          </select>
        </div>

        {/* Model Grid */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
          {filteredModels.map((model, index) => (
            <motion.div
              key={model.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: index * 0.05 }}
              className="border border-white/10 hover:border-white/20 transition-all group cursor-pointer"
              onClick={() => setSelectedModel(model)}
            >
              {/* Preview Image/3D */}
              <div className="aspect-[4/3] bg-gradient-to-br from-gray-900/20 to-black relative overflow-hidden">
                {model.originalPrice && (
                  <div className="absolute top-4 right-4 z-10">
                    <span className="px-2 py-1 bg-red-500/20 border border-red-500/50 text-[10px] font-light">
                      -{calculateDiscount(model)}%
                    </span>
                  </div>
                )}
                
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="text-center">
                    <div className="text-[100px] font-thin opacity-5">{model.id.slice(-2)}</div>
                    <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-500">
                      {model.brand}
                    </p>
                  </div>
                </div>
                
                <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
              </div>

              {/* Model Info */}
              <div className="p-6">
                <div className="flex items-start justify-between mb-3">
                  <div>
                    <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-500 mb-1">
                      {model.category} • {model.year}
                    </p>
                    <h3 className="text-lg font-light mb-1">{model.name}</h3>
                    <p className="text-[11px] font-extralight text-gray-400">
                      Scale {model.scale} • {model.fileSize}
                    </p>
                  </div>
                  <div className="text-right">
                    {model.originalPrice && (
                      <p className="text-[11px] line-through opacity-50">${model.originalPrice}</p>
                    )}
                    <p className="text-xl font-light">${model.price}</p>
                  </div>
                </div>

                {/* Quick Stats */}
                <div className="grid grid-cols-3 gap-2 mb-4 py-3 border-t border-white/5">
                  <div>
                    <Clock className="w-3 h-3 opacity-40 mb-1" />
                    <p className="text-[10px] font-extralight text-gray-400">{model.printTime}</p>
                  </div>
                  <div>
                    <Layers className="w-3 h-3 opacity-40 mb-1" />
                    <p className="text-[10px] font-extralight text-gray-400">{model.difficulty}</p>
                  </div>
                  <div>
                    <Star className="w-3 h-3 opacity-40 mb-1" />
                    <p className="text-[10px] font-extralight text-gray-400">
                      {model.popularity}/5
                    </p>
                  </div>
                </div>

                {/* Tags */}
                <div className="flex flex-wrap gap-1 mb-4">
                  {model.tags.slice(0, 3).map(tag => (
                    <span key={tag} className="text-[9px] px-2 py-1 border border-white/10 uppercase">
                      {tag}
                    </span>
                  ))}
                </div>

                {/* Action Button */}
                <button 
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDownload(model);
                  }}
                  className="w-full py-2 border border-white/10 hover:bg-white/5 transition-all text-[11px] font-extralight uppercase tracking-[0.2em]"
                >
                  Download STL
                </button>
              </div>
            </motion.div>
          ))}
        </div>

        {/* Stats */}
        <div className="grid grid-cols-4 gap-8 py-12 border-t border-white/5">
          <div className="text-center">
            <div className="text-3xl font-thin mb-2">{featuredModels.length}</div>
            <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-400">
              Models Available
            </p>
          </div>
          <div className="text-center">
            <div className="text-3xl font-thin mb-2">4.8</div>
            <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-400">
              Average Rating
            </p>
          </div>
          <div className="text-center">
            <div className="text-3xl font-thin mb-2">15K+</div>
            <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-400">
              Downloads
            </p>
          </div>
          <div className="text-center">
            <div className="text-3xl font-thin mb-2">24/7</div>
            <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-400">
              Support
            </p>
          </div>
        </div>
      </div>

      {/* Model Detail Modal */}
      <AnimatePresence>
        {selectedModel && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/90 z-50 overflow-y-auto"
            onClick={() => setSelectedModel(null)}
          >
            <motion.div
              initial={{ opacity: 0, y: 50 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 50 }}
              className="min-h-screen flex items-center justify-center p-8"
              onClick={(e) => e.stopPropagation()}
            >
              <div className="max-w-5xl w-full bg-black border border-white/10">
                {/* Modal Header */}
                <div className="flex items-center justify-between p-6 border-b border-white/10">
                  <div>
                    <p className="text-[10px] font-extralight uppercase tracking-[0.2em] text-gray-400 mb-2">
                      {selectedModel.brand} • {selectedModel.category}
                    </p>
                    <h2 className="text-2xl font-light">{selectedModel.name}</h2>
                  </div>
                  <button
                    onClick={() => setSelectedModel(null)}
                    className="text-2xl font-thin opacity-50 hover:opacity-100"
                  >
                    ×
                  </button>
                </div>

                {/* Modal Content */}
                <div className="grid md:grid-cols-2 gap-8 p-6">
                  {/* 3D Preview */}
                  <div className="aspect-square bg-gradient-to-br from-gray-900/20 to-black rounded-sm">
                    <Model3DViewer modelUrl={selectedModel.stlUrl} type="stl" />
                  </div>

                  {/* Details */}
                  <div className="space-y-6">
                    <div>
                      <p className="text-sm font-extralight text-gray-300 leading-relaxed">
                        {selectedModel.description}
                      </p>
                    </div>

                    {/* Specs */}
                    <div className="space-y-3">
                      <h3 className="text-xs font-light uppercase tracking-[0.2em]">Specifications</h3>
                      <div className="space-y-2 text-[11px] font-extralight">
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">Scale</span>
                          <span>{selectedModel.scale}</span>
                        </div>
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">Dimensions</span>
                          <span>
                            {selectedModel.dimensions.x} × {selectedModel.dimensions.y} × {selectedModel.dimensions.z} mm
                          </span>
                        </div>
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">Print Time</span>
                          <span>{selectedModel.printTime}</span>
                        </div>
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">Difficulty</span>
                          <span className="capitalize">{selectedModel.difficulty}</span>
                        </div>
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">File Size</span>
                          <span>{selectedModel.fileSize}</span>
                        </div>
                        <div className="flex justify-between py-2 border-b border-white/5">
                          <span className="text-gray-500">Polygons</span>
                          <span>{selectedModel.polygons.toLocaleString()}</span>
                        </div>
                      </div>
                    </div>

                    {/* Features */}
                    <div>
                      <h3 className="text-xs font-light uppercase tracking-[0.2em] mb-3">Features</h3>
                      <ul className="space-y-1 text-[11px] font-extralight text-gray-400">
                        {selectedModel.features.map(feature => (
                          <li key={feature}>• {feature}</li>
                        ))}
                      </ul>
                    </div>

                    {/* Price and Actions */}
                    <div className="pt-6 border-t border-white/10">
                      <div className="flex items-end justify-between mb-6">
                        <div>
                          {selectedModel.originalPrice && (
                            <p className="text-sm line-through opacity-50">
                              ${selectedModel.originalPrice}
                            </p>
                          )}
                          <p className="text-3xl font-thin">${selectedModel.price}</p>
                        </div>
                        {selectedModel.downloads && (
                          <p className="text-[10px] font-extralight text-gray-500">
                            {selectedModel.downloads.toLocaleString()} downloads
                          </p>
                        )}
                      </div>

                      <div className="flex gap-4">
                        <button 
                          onClick={() => handleDownload(selectedModel)}
                          className="flex-1 py-3 bg-white text-black font-light text-sm hover:bg-gray-200 transition-colors"
                        >
                          Download STL File
                        </button>
                        <button className="px-6 py-3 border border-white/10 hover:bg-white/5 transition-colors">
                          <ShoppingCart className="w-4 h-4" />
                        </button>
                      </div>

                      <p className="text-[10px] font-extralight text-gray-500 mt-4">
                        License: {selectedModel.license} use • Instant download after purchase
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </section>
  )
}
